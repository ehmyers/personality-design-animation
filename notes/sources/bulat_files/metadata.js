DISQUS.addBlocks("theme")(function(e){e.blocks.relatedThread=function(k,c){var a=new e.Builder,f=DISQUS.extend({},k,c);with(f)return a.put('    <li class="discovery-unit">        <div class="discovery-heading-wrapper">            <h3 title="'),a.put((a.esc||function(a){return a})(thread.title)),a.put('">                <a data-role="discovery-thread-title" class="title publisher-anchor-color" '),function(){var d={};e.extend(d,c);e.extend(d,{});a.put(e.renderBlock("linkAttributes",d))}(),a.put(">                    "),
a.put(thread.title),a.put('                </a>            </h3>        </div>        <ul class="meta">            <li class="comments">                <a '),function(){var d={};e.extend(d,c);e.extend(d,{});a.put(e.renderBlock("linkAttributes",d))}(),a.put(">                "),thread.posts==1?a.put("                    1 comment                "):thread.posts>=0&&(a.put("                    "),a.put((a.esc||function(a){return a})(thread.posts)),a.put(" comments                ")),a.put('                </a>            </li>            <li class="time">'),
a.put((a.esc||function(a){return a})(thread.createdAgo)),a.put('</li>        </ul>        <a class="top-comment" '),function(){var d={};e.extend(d,c);e.extend(d,{});a.put(e.renderBlock("linkAttributes",d))}(),a.put(' data-role="discovery-top-comment">            <img src="'),a.put((a.esc||function(a){return a})(urls.avatar.generic)),a.put('" alt="Default user" data-role="discovery-avatar">            <p><span class="user" data-role="discovery-top-comment-author">'),a.put('</span> &#8212; <span data-role="discovery-top-comment-snippet">'),
a.put("</span></p>        </a>    </li>"),a.compile()};e.blocks.linkAttributes=function(k,c){var a=new e.Builder,f=DISQUS.extend({},k,c);with(f)return a.put('href="'),a.put((a.esc||function(a){return a})(thread.link)),a.put('#disqus_thread" data-redirect="'),a.put((a.esc||function(a){return a})(thread.redirectUrl)),a.put('"'),a.compile()};e.blocks.relatedThreads=function(k,c){var a=new e.Builder,f=DISQUS.extend({},k,c);with(f)return a.put('<div id="discovery-main">    <div id="discovery-note" style="display:none;">        <div class="alert">            The new DISQUS Discovery box helps you find other vibrant discussions on the communities you love. Feedback? <a href="https://www.surveymonkey.com/s/GHK872T" target="_blank">Let us know.</a>        </div>    </div>    <header>        <div id="discovery-options">            <span class="publisher-anchor-color"><a href="#" id="discovery-help" data-action="discovery-help">What\'s this?</a></span>            <a href="#" id="discovery-close" data-action="discovery-close" title="Close this box">\u00d7</a>        </div>        <h2>Also on <strong>'),
a.put((a.esc||function(a){return a})(forum.name)),a.put('</strong></h2>    </header>    <section>        <ul id="discovery-units">            '),a.put("        </ul>    </section></div>"),a.compile()}});
(function(e){var k=e.document,c=e.DISQUS;c.registerActions=function(){c.define("discovery.views",function(){return{load:function(a){var f=c.discovery.views,d=f.RelatedThreadView=Backbone.View.extend({events:{"click [data-redirect]":"swapLink"},dtplBlock:"relatedThread",initialize:function(a){this.snippetLimit=a.snippetLimit;this.model.on("change:topComment",this.renderTopComment,this)},swapLink:function(a){a=a.target||a.srcElement;a.tagName.toUpperCase()=="A"&&a.getAttribute("data-redirect")||(a=
$(a).closest("a[data-redirect]")[0]);var b=a;b.setAttribute("data-href",b.getAttribute("href"));b.setAttribute("href",b.getAttribute("data-redirect"));_.delay(function(){b.setAttribute("href",b.getAttribute("data-href"))},100)},renderAvatar:function(a){var b=this.$el.find("[data-role=discovery-avatar]");b.attr("src",a.avatar.cache);b.attr("alt",this.authorName(a));return this},authorName:function(a){return a.name||a.username},renderCommentSnippet:function(j){var b=this.$el.find("[data-role=discovery-top-comment]");
if(j.author){var c=this.authorName(j.author);b.find("[data-role=discovery-top-comment-author]").text(c)}j=_.strip(j.message);j=_.truncate(j,this.snippetLimit,"\u2026");c=b.find("[data-role=discovery-top-comment-snippet]");c.text(j);b.css({display:"block"});a.lineTruncate(c,{lines:3,ellipsis:!0});return this},renderTopComment:function(a,b){this.renderAvatar(b.author);this.renderCommentSnippet(b);this.trigger("resize");return this},truncateHeading:function(){var j=this.$el.find("[data-role=discovery-thread-title]");
a.lineTruncate(j,{lines:2,ellipsis:!0})},render:function(){this.setElement(c.renderBlock(this.dtplBlock,{thread:_.extend(this.model.toJSON(),{createdAgo:moment(c.assureOffset(this.model.get("createdAt")),c.ISO_8601).fromNow()})}));return this}});f.RelatedThreadCollectionView=Backbone.View.extend({events:{"click [data-action=discovery-close]":"close","click [data-action=discovery-help]":"showHelp"},dtplBlock:"relatedThreads",initialize:function(a){this.snippetLimit=a.snippetLimit},close:function(a){a.preventDefault();
this.remove();this.trigger("resize",0)},showHelp:function(a){a.preventDefault();$(a.currentTarget).hide();this.$el.find("#discovery-note").show();this.trigger("resize")},getTopComment:function(a){var b=this;c.api.call("discovery/listTopPost.json",{method:"GET",data:{thread:a},success:function(a){a.response.length!==0&&_.each(a.response,function(a){b.collection.get(a.thread).set("topComment",a)})}});return b},resize:_.debounce(function(){this.trigger("resize")},500),render:function(){this.$el.append(c.renderBlock(this.dtplBlock,
{forum:this.collection.mainThread.get("forum")}));var a=[];this.collection.each(function(b){b=new d({model:b,snippetLimit:this.snippetLimit});a.push(b);b.on("resize",this.resize,this);b.render();this.$el.find("section > ul").append(b.el)},this);_.each(a,function(a){a.truncateHeading()});this.getTopComment(this.collection.pluck("id"));return this}});return f}}});c.define("discovery.collections",function(){return{load:function(a,f){var d=c.discovery.collections;d.RelatedThreadCollection=Backbone.Collection.extend({model:a.RelatedThread,
url:function(){return c.api.getURL("discovery/listRelated.json")},initialize:function(a,b){this.mainThread=b.thread;this.limit=b.limit;this.variant=b.variant},fetch:function(a){var b={};b.data={thread:this.mainThread.get("id")};b.parse=!1;_.extend(b,a);Backbone.Collection.prototype.fetch.call(this,b)},parse:function(a){var b=[],d=a.response,e=f.log;e("Results (",d.length,"):",d);for(var g=0,k=d.length;g<k&&b.length<this.limit;g++)if(a=d[g].thread||d[g],a.id!=this.mainThread.id)if(a.forum.id!=this.mainThread.get("forum").id)e("Thread",
a.id,"does not have same forum (",a.forum.id,") as source thread's:",this.mainThread.get("forum").id);else if(a.posts===0)e("Thread",a.id,"does not have any comments.");else if(a.title.indexOf("http://")===0)e("Thread",a.id,"has a title that starts with http.");else{var r=d[g].signedUrl?"http://redirect.disqus.com/url":a.link+"#redirect",m={url:d[g].signedUrl,thread:a.id,forum:_.isObject(a.forum)?a.forum.id:a.forum,zone:"internal_discovery",imp:c.juggler.impId,source_thread_id:this.mainThread.id};
if(this.variant)m.variant=this.variant;a.redirectUrl=c.serialize(r,m);a.score={score:d[g].score,k:d[g].k};b.push(a)}e("Total results:",b.length);return b}});return d}}});c.define("discovery.models",function(){return{load:function(){var a=c.discovery.models,e=a.Thread=Backbone.Model.extend({defaults:{author:null,category:null,createdAt:null,forum:null,identifiers:[],ipAddress:null,isClosed:!1,isDeleted:!1,link:null,message:null,slug:null,title:null,userSubscription:!1,posts:0,reactions:0,likes:0,dislikes:0,
userScore:0},url:c.api.getURL("threads/details"),parse:function(a){return a.response}});a.RelatedThread=e.extend({defaults:_.extend({},e.prototype.defaults,{redirectUrl:null,topComment:null})});return a}}});c.define("discovery.helpers",function(a,e){var d=null,j=!1,b=!1,h=function(){};a.console&&(h=function(){b&&(a.console.log.apply?a.console.log.apply(a.console,arguments):a.console.log(_.toArray(arguments).join(" ")))});var n=function(a){if(a===e)return b;b=!!a},g=function(a){if(a===e)return j;j=
!!a},l=function(a,b,c){if(d)if(d.length)d.enabled(a)&&b();else{var e=function(){d.enabled(a)&&b();c&&d.off("reset",e)};return void d.on("reset",e)}};return{config:function(a){d=a;l("discovery_next:logging",function(){n(!0)});l("discovery_next:truncate",function(){g(!0)})},allowLog:n,ifSwitch:l,log:h,allowLineTruncate:g,lineTruncate:function(b,d){function e(){return h.scrollHeight-h.offsetHeight>0.2*t}function g(){i.lastChild&&!_.contains(["...","\u2026"],i.lastChild.nodeValue)&&(q=i.appendChild(a.document.createTextNode(" "+
l)),e()&&(i.removeChild(q),i.removeChild(i.lastChild),g()))}if(j){var f=c.logError;if(!b.closest("body").length)return void f("lineTruncate called on el not on DOM");if(b.text().length<1)return void f("lineTruncated called on empty el");if(_.any(b.children(),function(a){return a.nodeType!==3}))return void f("lineTruncate called on non-flat el");var i=b[0],h=i;if(b.css("display")!=="block")for(;h.parentNode;)if(h=h.parentNode,$(h).css("display")==="block")break;var t=parseFloat(b.css("font-size"),
10);if(e()){var d=d||{},f=d.lines||1,l=d.ellipsis,q,o=b.text();if(o.length){var n=b.width()/t,f=parseInt(n*f,10),o=o.split(/\s/),n=0;b.empty();for(var p=0,u=o.length;p<u;p++){n+=o[p].length+1;if(n>=f)break;i.appendChild(k.createTextNode(" "+o[p]))}if(e()){do q=i.removeChild(i.lastChild);while(e())}else{do q=i.appendChild(k.createTextNode(" "+o[p++]));while(!e()&&p<u);i.removeChild(q)}l&&(_.isString(l)||(l="\u2026"),g())}}}}}});c.define("discovery",function(){return this.overwrites({init:function(a,
e){function d(d){k("discovery_next:dark_promoted",function(){g("Initiating dark request to discovery/listPromoted");c.api.call("discovery/listPromoted.json",{data:{thread:a.thread.id}})});i=new w(null,{thread:d,limit:l,variant:!!a.isExperiment&&a.variant});i.fetch({success:j,error:b});i.on("error",b)}function j(c){if(c.length<2)return void b({display:!1});c=new x({el:a.mainEl,collection:c,snippetLimit:r});e(c);b({display:!0})}function b(b){b=b||{};s||(s=!0,c.juggler&&(b={major_version:"next_internal",
internal_organic:i.length,external_organic:0,promoted:0,display:!!b.display},a.isExperiment&&_.extend(b,{variant:a.variant}),g("Juggler init_discovery",b),c.juggler.emit("init_discovery",b)))}var h=c.discovery.helpers,k=h.ifSwitch,g=h.log;h.config(a.switches);var l=4,r=100,m=c.discovery.models.load(),v=c.discovery.collections.load(m,h),h=c.discovery.views.load(h),m=m.Thread,w=v.RelatedThreadCollection,x=h.RelatedThreadCollectionView,i;a.threadId?(g("Discovery: Making call to threads/details"),(new m).fetch({data:{thread:a.threadId,
forum:a.forum,related:"forum"},success:d})):d(new m(_.extend(a.thread,{forum:a.forum})));var s=!1}})})};c.runThemeScript=c.registerActions})(this);